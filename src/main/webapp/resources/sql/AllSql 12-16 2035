DROP SEQUENCE SEQ_UID;
DROP SEQUENCE SEQ_LIKENO;
DROP SEQUENCE SEQ_MATCH;
DROP SEQUENCE SEQ_CHAT;
DROP SEQUENCE SEQ_RKEY;
DROP SEQUENCE SEQ_CRID;
DROP SEQUENCE SEQ_MSG;
DROP SEQUENCE SEQ_MATCH_HATE;



CREATE SEQUENCE SEQ_UID;
CREATE SEQUENCE SEQ_LIKENO;
CREATE SEQUENCE SEQ_MATCH;
CREATE SEQUENCE SEQ_CHAT;
CREATE SEQUENCE SEQ_RKEY;
CREATE SEQUENCE SEQ_CRID;
CREATE SEQUENCE SEQ_MSG;
CREATE SEQUENCE SEQ_MATCH_HATE;


DROP TABLE MEMBER CASCADE CONSTRAINTS;

CREATE TABLE MEMBER (
	U_MID	NUMBER		NOT NULL,
	USER_ID	NVARCHAR2(1000)		NOT NULL,
	USER_PWD	NVARCHAR2(1000)		NOT NULL,
	USER_NICK	NVARCHAR2(1000)		NOT NULL,
	GRADE	CHAR(1) CHECK(GRADE in('1', '2', '3')),
	GENDER	CHAR(1) CHECK(gender in('M', 'F'))		NOT NULL,
	PHONE	NVARCHAR2(1000)		NOT NULL,
	HEIGHT	NUMBER		NOT NULL,
	AGE	NUMBER		NOT NULL,
	ADDRESS	NVARCHAR2(1000)		NOT NULL,
	USER_INTO	NVARCHAR2(1000)		NOT NULL,
	GAY	CHAR(1) CHECK(gay in('Y', 'N'))		NOT NULL,
	R_COUNT	NUMBER		NOT NULL,
	UPDATA_DATE	DATE	DEFAULT SYSDATE	NOT NULL,
	STATUS	CHAR(1) CHECK(status in ('Y', 'N')),
	PAY_STATUS	CHAR(1) CHECK(PAY_STATUS IN ('Y','N')),
	KAKAO	NVARCHAR2(1000)		NULL
);

ALTER TABLE MEMBER MODIFY GRADE DEFAULT 1 NOT NULL;
ALTER TABLE MEMBER MODIFY PAY_STATUS DEFAULT 'N' NOT NULL;

COMMENT ON COLUMN MEMBER.U_MID IS '시퀀스를 통한 회원번호';

COMMENT ON COLUMN MEMBER.USER_ID IS '회원 아이디';

COMMENT ON COLUMN MEMBER.USER_PWD IS '회원 비밀번호';

COMMENT ON COLUMN MEMBER.USER_NICK IS '회원 별명';

COMMENT ON COLUMN MEMBER.GRADE IS '1:일반회원, 2:유료회원, 3:관리자, Default : 1번 일반회원';

COMMENT ON COLUMN MEMBER.GENDER IS '회원 성별 M:남자 F:여자';

COMMENT ON COLUMN MEMBER.PHONE IS '결제시 문자 넘어가는것';

COMMENT ON COLUMN MEMBER.HEIGHT IS '회원 키';

COMMENT ON COLUMN MEMBER.AGE IS '회원 나이';

COMMENT ON COLUMN MEMBER.ADDRESS IS '회원 사는 곳';

COMMENT ON COLUMN MEMBER.USER_INTO IS '한줄소개';

COMMENT ON COLUMN MEMBER.GAY IS '동성 매칭여부 Y or N';

COMMENT ON COLUMN MEMBER.R_COUNT IS '신고 누적횟수 DEFAULT:0';

COMMENT ON COLUMN MEMBER.UPDATA_DATE IS '가입날짜 Default : SYSDATE';

COMMENT ON COLUMN MEMBER.STATUS IS '회원 탈퇴여부 Default 값 : Y';

COMMENT ON COLUMN MEMBER.PAY_STATUS IS '기본값 N';

COMMENT ON COLUMN MEMBER.KAKAO IS '카카오 아이디 키 값';

DROP TABLE CHAT CASCADE CONSTRAINTS;

CREATE TABLE CHAT (
	CHATID	NUMBER		NOT NULL,
	CHATROOM	NVARCHAR2(20)		NULL,
	CREATEDATE	DATE	DEFAULT SYSDATE	NOT NULL,
	MODIFYDATE	DATE	DEFAULT SYSDATE	NULL,
	U_MID	NUMBER		NOT NULL,
	U_MID2	NUMBER		NOT NULL,
	STATUS	CHAR(1) CHECK(STATUS IN ('Y', 'N'))
);

ALTER TABLE CHAT MODIFY STATUS DEFAULT 'Y'	NOT NULL;

COMMENT ON COLUMN CHAT.CHATID IS '시퀀스 채팅방 번호';

COMMENT ON COLUMN CHAT.CHATROOM IS '채팅방 이름';

COMMENT ON COLUMN CHAT.CREATEDATE IS '채팅방 생성일';

COMMENT ON COLUMN CHAT.MODIFYDATE IS '채팅방 수정일 ( STATUS가 N으로 변경 시)';

COMMENT ON COLUMN CHAT.U_MID IS 'MEMBER 테이블 시퀀스를 통한 회원번호';

COMMENT ON COLUMN CHAT.U_MID2 IS 'MEMBER 테이블 시퀀스를 통한 회원번호2';

COMMENT ON COLUMN CHAT.STATUS IS '채팅방 상태';

DROP TABLE Payment CASCADE CONSTRAINTS;

CREATE TABLE Payment (
	payId	NVARCHAR2(1000)		NOT NULL,
	U_MID	NUMBER		NOT NULL,
	PAY_DATE	DATE		NOT NULL,
	USER_ID	NVARCHAR2(1000)		NOT NULL,
	PAY_LAST_DATE	DATE		NOT NULL
);

COMMENT ON COLUMN Payment.payId IS '결제시 아임포트에서 나오는것';

COMMENT ON COLUMN Payment.U_MID IS '시퀀스를 통한 회원번호';

DROP TABLE MLIKE CASCADE CONSTRAINTS;

CREATE TABLE MLIKE (
	LIKENO	NUMBER		NOT NULL,
	U_MID	NUMBER		NOT NULL,
	SENDER	NVARCHAR2(100)		NOT NULL,
	RECEIVER	NVARCHAR2(100)		NOT NULL,
	LIKESTATUS	CHAR(1)	DEFAULT 'Y'	NOT NULL,
	LIKESUSIN	NUMBER	DEFAULT 0	NOT NULL
);

COMMENT ON COLUMN MLIKE.LIKENO IS '시퀀스를 통한 좋아요넘버';

COMMENT ON COLUMN MLIKE.U_MID IS '시퀀스를 통한 회원번호';

COMMENT ON COLUMN MLIKE.SENDER IS '좋아요 보낸 유저';

COMMENT ON COLUMN MLIKE.RECEIVER IS '좋아요 받은 유저';

COMMENT ON COLUMN MLIKE.LIKESTATUS IS '좋아요 여부';

COMMENT ON COLUMN MLIKE.LIKESUSIN IS '좋아요 확인';

DROP TABLE MHATE;
CREATE TABLE MHATE(
    HATENO NUMBER PRIMARY KEY NOT NULL,
    U_MID NUMBER NOT NULL,
    H_SENDER VARCHAR2(500) NOT NULL,
    H_RECEIVER VARCHAR2(500) NOT NULL,
    H_STATUS VARCHAR2(10)
);

DROP TABLE Report CASCADE CONSTRAINTS;

CREATE TABLE Report (
	RKEY	NUMBER NOT NULL,
	U_MID	NUMBER NOT NULL,
	R_USER_ID	NVARCHAR2(20) NOT NULL,
	R_TYPE	CHAR(1) CHECK(R_TYPE IN ('1','2','3','4')) NOT NULL,
	R_CONTENTS	NVARCHAR2(1000)		NULL,
	R_DATE	DATE DEFAULT SYSDATE		NULL,
	STATUS	CHAR(1) CHECK(STATUS IN ('Y', 'N'))
);

ALTER TABLE REPORT MODIFY STATUS DEFAULT 'Y' NOT NULL;

COMMENT ON COLUMN Report.RKEY IS '시퀀스를 통한 신고번호';

COMMENT ON COLUMN Report.U_MID IS '시퀀스를 통한 회원번호';

COMMENT ON COLUMN Report.R_USER_ID IS '신고당한 유저 아이디';

COMMENT ON COLUMN Report.R_TYPE IS '1.부적절한 사진 2.스팸으로 의심 3.부적절한 메세지 4.기타';

COMMENT ON COLUMN Report.R_CONTENTS IS '신고 내용';

COMMENT ON COLUMN Report.R_DATE IS '신고 당한 마지막 날짜';

COMMENT ON COLUMN Report.STATUS IS '신고에 대한 관리자 확인 여부';

DROP TABLE MEMBERIMG CASCADE CONSTRAINTS;

CREATE TABLE MEMBERIMG (
	USER_ID	NVARCHAR2(1000)		NOT NULL,
	ORIGINALFILENAME	NVARCHAR2(1000)		NOT NULL,
	RENAMEFILENAME	NVARCHAR2(1000)		NOT NULL,
	IMG_COUNT	NUMBER		NOT NULL,
	UPDATE_DATE	DATE	DEFAULT SYSDATE	NOT NULL,
	STATUS	CHAR(1) CHECK(STATUS IN ('Y','N'))
);

ALTER TABLE MEMBERIMG MODIFY STATUS DEFAULT 'Y'	NOT NULL;

COMMENT ON COLUMN MEMBERIMG.USER_ID IS '회원아이디';

COMMENT ON COLUMN MEMBERIMG.ORIGINALFILENAME IS '원본명';

COMMENT ON COLUMN MEMBERIMG.RENAMEFILENAME IS '사진 변경명';

COMMENT ON COLUMN MEMBERIMG.IMG_COUNT IS '0 / 1 / 2 로 사람 확인';

COMMENT ON COLUMN MEMBERIMG.UPDATE_DATE IS '회원 업도르 사진입력';

COMMENT ON COLUMN MEMBERIMG.STATUS IS 'Y인지 N인지 디볼트 Y';

DROP TABLE HOBBY CASCADE CONSTRAINTS;

CREATE TABLE HOBBY (
	USER_ID	NVARCHAR2(1000)		NOT NULL,
	MOVIE	CHAR(1) CHECK(MOVIE IN ('Y','N')),
	SING	CHAR(1) CHECK(SING IN ('Y','N')),
	GAME	CHAR(1) CHECK(GAME IN ('Y','N')),
	JMT	CHAR(1) CHECK(JMT IN ('Y','N')),
	PET	CHAR(1) CHECK(PET IN ('Y','N')),
	CAFE	CHAR(1) CHECK(CAFE IN ('Y','N')),
	WORKING	CHAR(1) CHECK(WORKING IN ('Y','N')),
	POTO	CHAR(1) CHECK(POTO IN ('Y','N')),
	TRAVEL	CHAR(1) CHECK(TRAVEL IN ('Y','N'))
);

ALTER TABLE HOBBY MODIFY MOVIE DEFAULT 'N';
ALTER TABLE HOBBY MODIFY SING DEFAULT 'N';
ALTER TABLE HOBBY MODIFY GAME DEFAULT 'N';
ALTER TABLE HOBBY MODIFY JMT DEFAULT 'N';
ALTER TABLE HOBBY MODIFY PET DEFAULT 'N';
ALTER TABLE HOBBY MODIFY CAFE DEFAULT 'N';
ALTER TABLE HOBBY MODIFY WORKING DEFAULT 'N';
ALTER TABLE HOBBY MODIFY POTO DEFAULT 'N';
ALTER TABLE HOBBY MODIFY TRAVEL DEFAULT 'N';


DROP TABLE MESSAGE CASCADE CONSTRAINTS;

CREATE TABLE MESSAGE (
	mNo	NUMBER		NOT NULL,
	U_MID	NUMBER		NOT NULL,
	user_id	NVARCHAR2(100)		NOT NULL,
	toUser_id	NVARCHAR2(100)		NOT NULL,
	m_title	NVARCHAR2(500)		NOT NULL,
	m_content	NVARCHAR2(1000)		NOT NULL,
	m_date	NVARCHAR2(30)		NOT NULL,
	status	CHAR	DEFAULT 'Y'	NULL,
	SUSIN	NVARCHAR2(50)	DEFAULT '읽지않음'	NOT NULL
);

COMMENT ON COLUMN MESSAGE.mNo IS '시퀀스';

COMMENT ON COLUMN MESSAGE.U_MID IS '시퀀스를 통한 회원번호';

COMMENT ON COLUMN MESSAGE.SUSIN IS '메세지 수신확인 상태';

DROP TABLE CHATROOM CASCADE CONSTRAINTS;

CREATE TABLE CHATROOM (
	CR_ID	NUMBER		NOT NULL,
	CHATID	NUMBER		NOT NULL,
	CHATUSER	NVARCHAR2(10)		NOT NULL,
	C_CONTENT	NVARCHAR2(50)		NOT NULL,
	CHATDATE	DATE	DEFAULT SYSDATE	NULL,
    CHATTIME	NVARCHAR2(6)	DEFAULT TO_CHAR(SYSDATE, 'HH24:MI')	NULL,
	CONFIRM	NUMBER	DEFAULT 1	NOT NULL,
	STATUS	NVARCHAR2(1) CHECK(STATUS IN('Y', 'N')),
	IMG_STATUS	NVARCHAR2(1) CHECK(IMG_STATUS IN('Y', 'N'))
);

ALTER TABLE CHATROOM MODIFY STATUS DEFAULT 'Y'	NOT NULL;
ALTER TABLE CHATROOM MODIFY IMG_STATUS DEFAULT 'N'	NOT NULL;

COMMENT ON COLUMN CHATROOM.CR_ID IS '채팅용 인덱스';

COMMENT ON COLUMN CHATROOM.CHATID IS '시퀀스 채팅방 번호';

COMMENT ON COLUMN CHATROOM.CHATUSER IS '채팅 보낸 유저이름';

COMMENT ON COLUMN CHATROOM.C_CONTENT IS '채팅 내용';

COMMENT ON COLUMN CHATROOM.CHATTIME IS '채팅 시간';

COMMENT ON COLUMN CHATROOM.CONFIRM IS '채팅확인 유무';

COMMENT ON COLUMN CHATROOM.STATUS IS '채팅 삭제유무';

COMMENT ON COLUMN CHATROOM.IMG_STATUS IS '사진 업로드시';

ALTER TABLE MEMBER ADD CONSTRAINT PK_MEMBER PRIMARY KEY (
	U_MID
);

ALTER TABLE CHAT ADD CONSTRAINT PK_CHAT PRIMARY KEY (
	CHATID
);

ALTER TABLE Payment ADD CONSTRAINT PK_PAYMENT PRIMARY KEY (
	payId,
	U_MID
);

ALTER TABLE MLike ADD CONSTRAINT PK_LIKE PRIMARY KEY (
	LIKENO,
	U_MID
);

ALTER TABLE Report ADD CONSTRAINT PK_REPORT PRIMARY KEY (
	RKEY,
	U_MID
);

ALTER TABLE HOBBY ADD CONSTRAINT PK_HOBBY PRIMARY KEY (
	USER_ID
);

ALTER TABLE MESSAGE ADD CONSTRAINT PK_MESSAGE PRIMARY KEY (
	mNo
);

ALTER TABLE CHATROOM ADD CONSTRAINT PK_CHATROOM PRIMARY KEY (
	CR_ID,
	CHATID
);

ALTER TABLE CHAT ADD CONSTRAINT FK_MEMBER_TO_CHAT_1 FOREIGN KEY (
	U_MID
)
REFERENCES MEMBER (
	U_MID
);

ALTER TABLE Payment ADD CONSTRAINT FK_MEMBER_TO_Payment_1 FOREIGN KEY (
	U_MID
)
REFERENCES MEMBER (
	U_MID
);

ALTER TABLE MLike ADD CONSTRAINT FK_MEMBER_TO_Like_1 FOREIGN KEY (
	U_MID
)
REFERENCES MEMBER (
	U_MID
);

ALTER TABLE Report ADD CONSTRAINT FK_MEMBER_TO_Report_1 FOREIGN KEY (
	U_MID
)
REFERENCES MEMBER (
	U_MID
);

ALTER TABLE MESSAGE ADD CONSTRAINT FK_MEMBER_TO_MESSAGE_1 FOREIGN KEY (
	U_MID
)
REFERENCES MEMBER (
	U_MID
);

ALTER TABLE CHATROOM ADD CONSTRAINT FK_CHAT_TO_CHATROOM_1 FOREIGN KEY (
	CHATID
)
REFERENCES CHAT (
	CHATID
);

CREATE OR REPLACE VIEW CHATINFO
AS
SELECT CHATID, CHATROOM, M1.USER_ID AS USER_ID, M2.USER_ID AS USER_ID2, M1.USER_NICK AS USERNAME, M2.USER_NICK AS USERNAME2, C.STATUS
FROM CHAT C
JOIN MEMBER M1 ON(C.U_MID = M1.U_MID)
JOIN MEMBER M2 ON(C.U_MID2 = M2.U_MID);

CREATE OR REPLACE VIEW CHATUSER
AS
SELECT I.USER_ID, C.CHATID, M.U_MID, M.USER_NICK, RENAMEFILENAME, SUM(CONFIRM) AS CONSUM
FROM MEMBERIMG I
JOIN MEMBER M ON(I.USER_ID = M.USER_ID)
JOIN CHAT C ON ((C.U_MID = M.U_MID) OR (C.U_MID2 = M.U_MID))
LEFT OUTER JOIN CHATROOM CR ON (C.CHATID = CR.CHATID AND M.USER_NICK = CR.CHATUSER)
WHERE C.STATUS = 'Y' AND IMG_COUNT = 0
GROUP BY C.CHATID, M.U_MID, I.USER_ID, M.USER_NICK, RENAMEFILENAME, CHATUSER;